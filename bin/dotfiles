#!/bin/bash

# go to dotfiles dir
cd $(readlink -f $(dirname $0))/..

prompt() {
	read -p "$1 (y/n) " -n 1 -r
	echo
	case $REPLY in
		y|Y)
			retval=0
			;;
		*)
			retval=1
			;;
	esac
	return "$retval"
}

mkdir_if_none() {
	if [ ! -d $1 ]; then
		mkdir $1
	fi
}

pre_install() {
	# initialize submodules
	git submodule --quiet update --init --recursive
	# neobundle
	LWD=$PWD
	cd $PWD/vim/bundle/neobundle
	git checkout --quiet master
	cd $LWD
	# fonts
	mkdir_if_none $HOME/.fonts
	ln -sf $PWD/fonts/Meslo/MesloLGM-Regular.ttf $HOME/.fonts/MesloLGM-Regular.ttf
	fc-cache -vf $HOME/.fonts > /dev/null
}

install() {
	pre_install
	ln -sf $PWD/bin            $HOME/bin
	ln -sf $PWD/ctags/ctags    $HOME/.ctags
	ln -sf $PWD/git/gitconfig  $HOME/.gitconfig
	ln -sf $PWD/git/gitignore  $HOME/.gitignore
	ln -sf $PWD/i3             $HOME/.i3
	ln -sf $PWD/sh/aliases     $HOME/.aliases
	ln -sf $PWD/sh/profile     $HOME/.profile
	ln -sf $PWD/tmux/tmux.conf $HOME/.tmux.conf
	ln -sf $PWD/vim            $HOME/.vim
	ln -sf $PWD/xorg/xinitrc    $HOME/.xinitrc
	ln -sf $PWD/xorg/Xresources $HOME/.Xresources
	ln -sf $PWD/zsh            $HOME/.zsh
	ln -sf $PWD/zsh/zshenv     $HOME/.zshenv
	ln -sf $PWD/zsh/zshrc      $HOME/.zshrc
}

remove() {
	if prompt "WARNING: This will destroy any existing config files! Continue?"; then
		rm -rf $HOME/bin
		rm -rf $HOME/.ctags
		rm -rf $HOME/.gitconfig
		rm -rf $HOME/.gitignore
		rm -rf $HOME/.i3
		rm -rf $HOME/.aliases
		rm -rf $HOME/.profile
		rm -rf $HOME/.tmux.conf
		rm -rf $HOME/.vim
		rm -rf $HOME/.vimrc
		rm -rf $HOME/.xinitrc
		rm -rf $HOME/.Xresources
		rm -rf $HOME/.zsh
		rm -rf $HOME/.zshenv
		rm -rf $HOME/.zshrc
		retval=0
	else
		retval=1
	fi
	return "$retval"
}

config() {
	# compile YouCompleteMe
	if prompt "Compile YouCompleteMe?"; then
		FLAGS=""
		if prompt "  semantic completion for C-family languages?"; then
			FLAGS="$FLAGS --clang-completer"
			if prompt "    use system libclang?"; then
				FLAGS="$FLAGS --system-libclang"
			fi
		fi
		if prompt "  semantic completion for C#?"; then
			FLAGS="$FLAGS --omnisharp-completer"
		fi
		LWD=$PWD
		cd $PWD/vim/bundle/YouCompleteMe
		./install.sh $FLAGS
		cd $LWD
	fi
}

case $1 in
install)
	if remove; then
		install
	fi
	;;
remove)
	remove
	;;
config)
	config
	;;
*)
	echo "Options:"
	echo "  install - symlink dotfiles"
	echo "  remove  - remove all dotfiles"
	echo "  config  - config plugins"
	;;
esac
