#!/bin/bash

cd $(readlink -f $(dirname $0))/..

prompt() {
	read -p "$1 (y/n) " -n 1 -r
	echo
	case $REPLY in
		y|Y)
			retval=0
			;;
		*)
			retval=1
			;;
	esac
	return "$retval"
}

mkdir_if_none() {
	if [ ! -d $1 ]; then
		mkdir $1
	fi
}

pre_install() {
	# initialize submodules
	git submodule --quiet update --init --recursive
	# create directories
	mkdir_if_none $HOME/.fonts
	mkdir_if_none $HOME/.config
}

install() {
	if remove; then
		pre_install
		ln -sf $PWD/bin             $HOME/bin
		ln -sf $PWD/ctags/ctags     $HOME/.ctags
		ln -sf $PWD/fontconfig      $HOME/.config/fontconfig
		ln -sf $PWD/git/gitconfig   $HOME/.gitconfig
		ln -sf $PWD/git/gitignore   $HOME/.gitignore
		ln -sf $PWD/i3              $HOME/.i3
		ln -sf $PWD/powerline       $HOME/.config/powerline
		ln -sf $PWD/tmux/tmux.conf  $HOME/.tmux.conf
		ln -sf $PWD/vim             $HOME/.vim
		ln -sf $PWD/xorg/Xresources $HOME/.Xresources
		ln -sf $PWD/zsh             $HOME/.zsh
		ln -sf $PWD/zsh/zshrc       $HOME/.zshrc
		# fonts
		ln -sf $PWD/fonts/powerline/Meslo/Meslo\ LG\ M\ Regular\ for\ Powerline.otf $HOME/.fonts/MesloLGM-regular-powerline.otf
		post_install
	fi
}

post_install() {
	# cache fonts
	fc-cache -vf $HOME/.fonts > /dev/null
	# install vim plugins
	vim +qall
	# compile YouCompleteMe
	if prompt "Compile YouCompleteMe?"; then
		FLAGS=""
		if prompt "  semantic completion for C-family languages?"; then
			FLAGS="$FLAGS --clang-completer"
			if prompt "    use system libclang?"; then
				FLAGS="$FLAGS --system-libclang"
			fi
		fi
		if prompt "  semantic completion for C#?"; then
			FLAGS="$FLAGS --omnisharp-completer"
		fi
		LWD=$PWD
		cd $PWD/vim/bundle/YouCompleteMe
		./install.sh $FLAGS
		cd $LWD
	fi
}

remove() {
	if prompt "WARNING: This will destroy any existing config files! Continue?"; then
		rm -rf $HOME/bin
		rm -rf $HOME/.config/fontconfig
		rm -rf $HOME/.config/powerline
		rm -rf $HOME/.ctags
		rm -rf $HOME/.gitconfig
		rm -rf $HOME/.gitignore
		rm -rf $HOME/.i3
		rm -rf $HOME/.tmux.conf
		rm -rf $HOME/.vim
		rm -rf $HOME/.vimrc
		rm -rf $HOME/.Xresources
		rm -rf $HOME/.zsh
		rm -rf $HOME/.zshrc
		retval=0
	else
		retval=1
	fi
	return "$retval"
}

case $1 in
	install|remove)
		$1
		;;
	config)
		post_install
		;;
	*)
		echo "Options:"
		echo "  install - symlink dotfiles"
		echo "  remove  - remove all dotfiles"
		echo "  config  - configure plugins"
		exit 1
esac
